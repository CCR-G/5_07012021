(()=>{"use strict";function t(t,e=document){const a=e.querySelector(`[data='${t}']`);if(!(a instanceof HTMLElement))throw new Error(`data='${t}' could not be found or is not an HTMLElement`);return a}function e(e){const a=t("basket-quantity");a.textContent=e.quantity,window.addEventListener("storage",(()=>{console.log("TESTEST"),a.textContent=e.quantity}))}class a{constructor(t,e,a){this._id=t._id+e,this.furniture=t,this.customisation=e,this.quantity=a,this.updated_quantity_event=new CustomEvent("updated_quantity",{detail:{updated_basket_item:this}})}get totalPrice(){return this.furniture.price*this.quantity}addToQuantity(t){this.quantity+=t}removeFromQuantity(t){this.quantity=t||0}clear(){this.quantity=0,window.dispatchEvent(this.updated_quantity_event)}updateQuantity(t){this.quantity=t,window.dispatchEvent(this.updated_quantity_event)}}class n{constructor(){this.basket_storage={},this.updateBasket(),e(this),window.addEventListener("updated_quantity",(t=>{this.replaceItem(t.detail.updated_basket_item)}))}updateBasket(){const t=window.localStorage.getItem("basket");if(t){const e=JSON.parse(t);for(const t in e){const n=new a(e[t].furniture,e[t].customisation,e[t].quantity);this.add(n)}}}replaceItem(t){this.basket_storage[t._id]=t,this.basket_storage[t._id].quantity||delete this.basket_storage[t._id],e(this),this.updateLocalStorage()}add(t){this.basket_storage[t._id]?this.basket_storage[t._id].addToQuantity(t.quantity):this.basket_storage[t._id]=t,this.updateLocalStorage()}clear(){this.basket_storage={},this.updateLocalStorage()}get quantity(){let t=0;for(const e in this.basket_storage)t+=this.basket_storage[e].quantity;return t}get isEmpty(){return 0===this.quantity}get totalPrice(){let t=0;for(const e in this.basket_storage)t+=this.basket_storage[e].totalPrice;return t}get content(){return this.basket_storage}updateLocalStorage(){const t=JSON.stringify(this.basket_storage);window.localStorage.setItem("basket",t)}}class i{constructor(t,e){this.contact=t,this.products=e}get(){return{contact:this.contact,products:this.products}}}class s{constructor(t,e,a,n,i){this.firstName=t,this.lastName=e,this.address=a,this.city=n,this.email=i}}function o(e){let a=t("basket-item-template"),n=document.importNode(a.content,!0);!function(t,e=document){const a=e.querySelector("[data='item-name']");a&&(a.textContent=t.name);const n=e.querySelector("[data='item-link']");n&&(n.href=`item.html?id=${t._id}`,n.title=`Naviguer vers la page ${t.name}`);const i=e.querySelector("[data='item-price']");i&&(i.textContent=t.price);const s=e.querySelector("[data='item-description']");s&&(s.textContent=t.description);const o=e.querySelector("[data='item-image']");o&&(o.src=t.imageUrl);const r=e.querySelector("[data='item-customisation']");r&&t.varnish.forEach((t=>{const e=document.createElement("option");e.textContent=t,r.appendChild(e)}))}(e.furniture,n);let i=t("basket-item-quantity",n);return i.value=e.quantity,i.addEventListener("change",(()=>{let t=parseInt(i.value);t>=0?e.updateQuantity(t):i.value=e.quantity})),t("basket-item-customisation",n).textContent=e.customisation,t("basket-item-clear",n).addEventListener("click",(()=>{e.clear(),i.value=e.quantity})),n}!function e(){let a=new n;const r=t("basket-items-container");r.innerText="";const c=a.content;for(const t in c){const e=o(c[t]);r.appendChild(e)}const u=t("basket-price");u.textContent=a.totalPrice,window.addEventListener("updated_quantity",(()=>{u.textContent=a.totalPrice})),t("basket-clear").addEventListener("click",(()=>{a.clear(),e()})),function(a){let n=t("send-command-form");a.content,a.isEmpty&&(n.submit.disabled=!0),n.addEventListener("submit",(t=>{t.preventDefault();let o=a.content;a.isEmpty?alert("No items in basket, please fill your basket with our fantastic furnitures!"):async function(t){const e=await fetch("http://localhost:3000/api/furniture/order",{method:"POST",body:JSON.stringify(t.get()),headers:{"Content-type":"application/json"}});if(!e.ok)throw new Error(`Error ${item.status} : There has been a problem.`);return e.json()}(function(t,e){let a=new s(t.full_name.value,t.used_name.value,t.address.value,t.town.value,t.email.value),n=[];return Object.keys(e).forEach((t=>{let a=e[t],i=0;for(;i<a.quantity;)n.push(a.furniture._id),i++})),new i(a,n)}(n,o)).then((t=>{const i={order_id:t.orderId,order_price:a.totalPrice},s=JSON.stringify(i);window.localStorage.setItem("last-order",s),n.reset(),a.clear(),e(),window.location="command-confirm.html"}))}))}(a)}()})();