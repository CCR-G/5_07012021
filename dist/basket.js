(()=>{"use strict";function t(t,e=document){const a=e.querySelector(`[data='${t}']`);if(!(a instanceof HTMLElement))throw new Error(`data='${t}' could not be found or is not an HTMLElement`);return a}function e(e){const a=t("basket-quantity");a.textContent=e.getItemsNumber(),window.addEventListener("storage",(()=>{console.log("TESTEST"),a.textContent=e.getItemsNumber()}))}class a{constructor(t,e,a){this._id=t._id+e,this.furniture=t,this.customisation=e,this.quantity=a,this.updated_quantity_event=new CustomEvent("updated_quantity",{detail:{updated_basket_item:this}})}getBasketItemTotalPrice(){return this.furniture.price*this.quantity}addToQuantity(t){this.quantity+=t}removeFromQuantity(t){this.quantity=t||0}clear(){this.quantity=0,window.dispatchEvent(this.updated_quantity_event)}updateQuantity(t){this.quantity=t,window.dispatchEvent(this.updated_quantity_event)}}class i{constructor(){this.basket_storage={},this.updateBasket(),e(this),window.addEventListener("updated_quantity",(t=>{this.replaceItem(t.detail.updated_basket_item)}))}updateBasket(){const t=window.localStorage.getItem("basket");if(t){const e=JSON.parse(t);for(const t in e){const i=new a(e[t].furniture,e[t].customisation,e[t].quantity);this.add(i)}}}replaceItem(t){this.basket_storage[t._id]=t,this.basket_storage[t._id].quantity||delete this.basket_storage[t._id],e(this),this.updateLocalStorage()}add(t){this.basket_storage[t._id]?this.basket_storage[t._id].addToQuantity(t.quantity):this.basket_storage[t._id]=t,this.updateLocalStorage()}clear(){this.basket_storage={},this.updateLocalStorage()}getItemsNumber(){let t=0;for(const e in this.basket_storage)t+=this.basket_storage[e].quantity;return t}isEmpty(){return 0===this.getItemsNumber()}getBasketTotalPrice(){let t=0;for(const e in this.basket_storage)t+=this.basket_storage[e].getBasketItemTotalPrice();return t}getBasketStorage(){return this.basket_storage}updateLocalStorage(){const t=JSON.stringify(this.basket_storage);window.localStorage.setItem("basket",t)}}class s{constructor(t,e){this.contact=t,this.products=e}get(){return{contact:this.contact,products:this.products}}}class n{constructor(t,e,a,i,s){this.firstName=t,this.lastName=e,this.address=a,this.city=i,this.email=s}}function o(e){let a=t("basket-item-template"),i=document.importNode(a.content,!0);!function(t,e=document){const a=e.querySelector("[data='item-name']");a&&(a.textContent=t.name);const i=e.querySelector("[data='item-link']");i&&(i.href=`item.html?id=${t._id}`,i.title=`Naviguer vers la page ${t.name}`);const s=e.querySelector("[data='item-price']");s&&(s.textContent=t.price);const n=e.querySelector("[data='item-description']");n&&(n.textContent=t.description);const o=e.querySelector("[data='item-image']");o&&(o.src=t.imageUrl);const r=e.querySelector("[data='item-customisation']");r&&t.varnish.forEach((t=>{const e=document.createElement("option");e.textContent=t,r.appendChild(e)}))}(e.furniture,i);let s=t("basket-item-quantity",i);return s.value=e.quantity,s.addEventListener("change",(()=>{let t=parseInt(s.value);t>=0?e.updateQuantity(t):s.value=e.quantity})),t("basket-item-customisation",i).textContent=e.customisation,t("basket-item-clear",i).addEventListener("click",(()=>{e.clear(),s.value=e.quantity})),i}!function e(){let a=new i;const r=t("basket-items-container");r.innerText="";const c=a.getBasketStorage();for(const t in c){const e=o(c[t]);r.appendChild(e)}const u=t("basket-price");u.textContent=a.getBasketTotalPrice(),window.addEventListener("updated_quantity",(()=>{u.textContent=a.getBasketTotalPrice()})),t("basket-clear").addEventListener("click",(()=>{a.clear(),e()})),function(a){let i=t("send-command-form");a.getBasketStorage(),a.isEmpty()&&(i.submit.disabled=!0),i.addEventListener("submit",(t=>{t.preventDefault();let o=a.getBasketStorage();a.isEmpty()?alert("No items in basket, please fill your basket with our fantastic furnitures!"):async function(t){const e=await fetch("http://localhost:3000/api/furniture/order",{method:"POST",body:JSON.stringify(t.get()),headers:{"Content-type":"application/json"}});if(!e.ok)throw new Error(`Error ${item.status} : There has been a problem.`);return e.json()}(function(t,e){let a=new n(t.full_name.value,t.used_name.value,t.address.value,t.town.value,t.email.value),i=[];return Object.keys(e).forEach((t=>{let a=e[t],s=0;for(;s<a.quantity;)i.push(a.furniture._id),s++})),new s(a,i)}(i,o)).then((t=>{const s={order_id:t.orderId,order_price:a.getBasketTotalPrice()},n=JSON.stringify(s);window.localStorage.setItem("last-order",n),i.reset(),a.clear(),e(),window.location="command-confirm.html"}))}))}(a)}()})();